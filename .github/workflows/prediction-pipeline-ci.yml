name: Prediction Pipeline CI with LLM Output

on:
  push:
    branches: [main]
  pull_request:
  schedule:
    # JPå¸‚å ´çµ‚å€¤å¾Œï¼šæ¯Žå–¶æ¥­æ—¥ UTC 06:00ï¼ˆæ—¥æœ¬æ™‚é–“ 15:00ï¼‰
    - cron: '0 6 * * 1-5'
    # USå¸‚å ´çµ‚å€¤å¾Œï¼šæ¯Žå–¶æ¥­æ—¥ UTC 21:00ï¼ˆæ—¥æœ¬æ™‚é–“ ç¿Œæ—¥ 06:00ï¼‰
    - cron: '0 21 * * 1-5'
  workflow_dispatch:

jobs:
  predict_and_validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install holidays
          if [ -f prediction_pipeline/requirements.txt ]; then
            pip install -r prediction_pipeline/requirements.txt
          fi

      - name: Verify validation helpers
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.validation_helpers import (
              is_trading_day,
              validate_price_prediction,
              detect_scale_error,
              recalculate_confidence
          )
          print('âœ… All validation helpers imported successfully')
          "

      - name: Generate forecast CSV from real stock data
        run: |
          echo "ðŸ“Š Generating forecast from real stock data..."
          PYTHONPATH=. python scripts/generate_forecast_csv.py \
            --output forecast_data.csv \
            --us-symbols AAPL GOOGL MSFT TSLA \
            --jp-symbols 9984 6758 7203 8306
          
          echo "âœ… Forecast CSV generated"
          echo "ðŸ“‹ File content:"
          head -20 forecast_data.csv
          echo "ðŸ“Š Total rows: $(wc -l < forecast_data.csv)"

      - name: Run prediction with validation
        run: |
          echo "ðŸ” Running prediction with validation..."
          PYTHONPATH=. python src/predict.py \
            --csv forecast_data.csv \
            --output darwin_analysis/forecast_analysis.json \
            --validate \
            --verbose
          
          echo "âœ… Prediction completed"
          python -c "
          import json
          with open('darwin_analysis/forecast_analysis.json') as f:
              data = json.load(f)
          
          print(f'Symbols: {data.get(\"symbols_predicted\", 0)}')
          print(f'Total predictions: {data.get(\"total_predictions\", 0)}')
          print(f'Status: {data.get(\"generation_status\", \"unknown\")}')
          print(f'Valid predictions: {data.get(\"summary\", {}).get(\"valid_predictions\", 0)}')
          print(f'Error predictions: {data.get(\"summary\", {}).get(\"error_predictions\", 0)}')
          print(f'Data quality: {data.get(\"summary\", {}).get(\"data_quality\", \"unknown\")}')
          "

      - name: Validate JSON structure
        run: |
          echo "ðŸ” Validating JSON structure..."
          python -c "
          import json
          import sys
          
          try:
              with open('darwin_analysis/forecast_analysis.json') as f:
                  data = json.load(f)
              
              required_fields = [
                  'timestamp',
                  'next_trading_day',
                  'symbols_predicted',
                  'total_predictions',
                  'forecasts',
                  'statistics',
                  'summary',
                  'data_issues'
              ]
              
              missing = [f for f in required_fields if f not in data]
              
              if missing:
                  print(f'âŒ Missing fields: {missing}')
                  sys.exit(1)
              
              if not isinstance(data['forecasts'], list):
                  print('âŒ forecasts is not a list')
                  sys.exit(1)
              
              for forecast in data['forecasts']:
                  required_pred_fields = [
                      'symbol', 'date', 'forecast', 'confidence',
                      'validation', 'scale_check'
                  ]
                  missing_pred = [f for f in required_pred_fields if f not in forecast]
                  if missing_pred:
                      print(f'âŒ Missing prediction fields in {forecast.get(\"symbol\")}: {missing_pred}')
                      sys.exit(1)
              
              print('âœ… JSON structure is valid')
              print(f'âœ… {len(data[\"forecasts\"])} forecasts validated')
              
          except json.JSONDecodeError as e:
              print(f'âŒ JSON decode error: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ Error: {e}')
              sys.exit(1)
          "

      - name: Generate LLM Prompts
        run: |
          echo "ðŸ§  Generating LLM prompts..."
          mkdir -p darwin_analysis/llm_prompts
          
          PYTHONPATH=. python src/llm_prompt_generator.py \
            --json darwin_analysis/forecast_analysis.json \
            --output darwin_analysis/llm_prompts
          
          echo "âœ… LLM prompts generated"
          echo "ðŸ“‹ Generated files:"
          ls -la darwin_analysis/llm_prompts/

      - name: Generate quality report
        run: |
          python scripts/generate_quality_report.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prediction-analysis-${{ github.run_number }}
          path: darwin_analysis/
          retention-days: 30

      - name: Summary
        run: |
          echo "## âœ… Pipeline Completed"
          echo ""
          echo "### ðŸ“ Generated Files"
          echo "- **JSON Analysis**: darwin_analysis/forecast_analysis.json"
          echo "- **LLM Prompts**: darwin_analysis/llm_prompts/"
          echo "- **Quality Report**: darwin_analysis/QUALITY_REPORT.md"
          echo ""
          echo "### ðŸ§  Ready for LLM Analysis"
          echo "Copy any prompt from darwin_analysis/llm_prompts/ to:"
          echo "- Claude: https://claude.ai"
          echo "- GPT-4: https://openai.com/chat"
          echo "- Gemini: https://gemini.google.com"
          echo "- Perplexity: https://perplexity.ai"
          echo ""
          echo "Each LLM will provide its own analysis based on the same data."
