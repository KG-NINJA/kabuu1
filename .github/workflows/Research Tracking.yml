name: Research Tracking - Update Accuracy Metrics

on:
  # æ¯å–¶æ¥­æ—¥ 22:00 UTCï¼ˆæ—¥æœ¬æ™‚é–“ ç¿Œæ—¥ 07:00ï¼‰ã«å®Ÿè¡Œ
  # ã“ã®ã¨ãã«ã¯å‰å–¶æ¥­æ—¥ã®çµ‚å€¤ãŒç¢ºå®šã—ã¦ã„ã‚‹
  schedule:
    - cron: "0 22 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  track_accuracy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance

      - name: Fetch actual prices from yesterday
        run: |
          echo "ğŸ“Š Fetching yesterday's closing prices..."
          python3 << 'EOF'
          import yfinance as yf
          import json
          from datetime import datetime, timedelta
          from pathlib import Path
          
          # æ˜¨æ—¥ã®æ—¥ä»˜ã‚’å–å¾—
          yesterday = (datetime.now() - timedelta(days=1)).date()
          
          symbols = {
              "AAPL": "AAPL",
              "GOOGL": "GOOGL",
              "MSFT": "MSFT",
              "TSLA": "TSLA",
              "7203": "7203.T",
              "6758": "6758.T",
              "8306": "8306.T",
              "9984": "9984.T"
          }
          
          for symbol, yf_symbol in symbols.items():
              try:
                  stock = yf.Ticker(yf_symbol)
                  hist = stock.history(start=yesterday, end=yesterday + timedelta(days=1))
                  if not hist.empty:
                      close_price = hist["Close"].iloc[-1]
                      print(f"âœ… {symbol}: {close_price:.2f}")
                  else:
                      print(f"âš ï¸ {symbol}: No data for {yesterday}")
              except Exception as e:
                  print(f"âŒ {symbol}: Error - {e}")
          EOF

      - name: Run research tracking system
        run: |
          echo "ğŸ“ˆ Running research tracking system..."
          PYTHONPATH=. python scripts/research_tracking_system.py
          echo "âœ… Tracking complete"

      - name: Generate research report
        run: |
          echo "ğŸ“„ Generating research report..."
          python3 << 'EOF'
          from pathlib import Path
          from scripts.research_tracking_system import PredictionResearchTracker
          
          tracker = PredictionResearchTracker()
          report = tracker.generate_research_report()
          
          # ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
          report_path = Path("data/research") / f"report_{Path.cwd().name}.md"
          report_path.write_text(report)
          
          print(report)
          EOF

      - name: Export datasets
        run: |
          echo "ğŸ’¾ Exporting research datasets..."
          python3 << 'EOF'
          from scripts.research_tracking_system import PredictionResearchTracker
          
          tracker = PredictionResearchTracker()
          tracker.export_dataset("csv")
          tracker.export_dataset("json")
          print("âœ… Datasets exported")
          EOF

      - name: Commit research data
        run: |
          git config user.email "research@github.com"
          git config user.name "Research Bot"
          git add data/research/
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“Š Research tracking update - $(date +'%Y-%m-%d')"
            git push origin main
          else
            echo "â„¹ï¸ No changes to commit"
          fi
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## âœ… Research Tracking Complete"
          echo ""
          echo "### ğŸ“ Generated Files"
          ls -lh data/research/ || echo "No files yet"
          echo ""
          echo "### ğŸ“Š Research Dataset"
          echo "- CSV: data/research/research_dataset.csv"
          echo "- JSON: data/research/research_dataset.json"
          echo "- Report: data/research/report_*.md"
