name: Debug Pipeline Execution - Detailed

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Step 1 - Test data fetching
        run: |
          echo "=== Testing Data Fetcher ==="
          PYTHONPATH=. python << 'EOF'
          from src.data_fetcher import fetch_stock_data
          from datetime import datetime, timedelta
          
          print("Fetching NVDA data...")
          end_date = datetime.now().date()
          start_date = end_date - timedelta(days=30)
          
          df = fetch_stock_data(us_symbols=['NVDA'], jp_symbols=[], start_date=start_date, end_date=end_date)
          print(f"Data fetched: {len(df)} rows")
          print(f"Columns: {list(df.columns)}")
          if len(df) > 0:
              print(f"First row: {df.iloc[0].to_dict()}")
              print(f"Last row: {df.iloc[-1].to_dict()}")
          EOF

      - name: Step 2 - Test model initialization
        run: |
          echo "=== Testing Model Initialization ==="
          PYTHONPATH=. python << 'EOF'
          import logging
          logging.basicConfig(level=logging.DEBUG)
          
          from src.prediction_pipeline import Config, PredictionModel
          
          config = Config()
          print("Config loaded")
          
          try:
              model = PredictionModel(config, "NVDA")
              print(f"Model initialized: trained={model._is_trained}")
              print(f"Feature columns: {model.feature_columns}")
          except Exception as e:
              print(f"Error initializing model: {e}")
              import traceback
              traceback.print_exc()
          EOF

      - name: Step 3 - Test pipeline initialization
        run: |
          echo "=== Testing Pipeline Initialization ==="
          PYTHONPATH=. python << 'EOF'
          import logging
          logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(name)s - %(levelname)s - %(message)s")
          
          from src.prediction_pipeline import Config, PredictionPipeline
          
          try:
              config = Config()
              print("Config loaded")
              
              pipeline = PredictionPipeline(config)
              print(f"Pipeline initialized")
              print(f"Target symbol: {pipeline.target_symbol}")
              print(f"Model trained: {pipeline.model._is_trained}")
          except Exception as e:
              print(f"Error initializing pipeline: {e}")
              import traceback
              traceback.print_exc()
          EOF

      - name: Step 4 - Test feature preparation
        run: |
          echo "=== Testing Feature Preparation ==="
          PYTHONPATH=. python << 'EOF'
          import logging
          logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(name)s - %(levelname)s - %(message)s")
          
          from src.prediction_pipeline import Config, PredictionPipeline
          
          try:
              config = Config()
              pipeline = PredictionPipeline(config)
              
              print("Preparing features for NVDA...")
              features = pipeline.prepare_features("NVDA")
              print(f"Features prepared: {features}")
          except Exception as e:
              print(f"Error preparing features: {e}")
              import traceback
              traceback.print_exc()
          EOF

      - name: Step 5 - Test single prediction
        run: |
          echo "=== Testing Single Prediction ==="
          PYTHONPATH=. python << 'EOF'
          import logging
          logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(name)s - %(levelname)s - %(message)s")
          
          from src.prediction_pipeline import Config, PredictionPipeline
          
          try:
              config = Config()
              pipeline = PredictionPipeline(config)
              
              print("Preparing features...")
              features = pipeline.prepare_features("NVDA")
              
              print("Running prediction...")
              result = pipeline.predict("NVDA", features)
              print(f"Prediction result: {result}")
          except Exception as e:
              print(f"Error in prediction: {e}")
              import traceback
              traceback.print_exc()
          EOF

      - name: Step 6 - Test full cycle
        run: |
          echo "=== Testing Full Cycle ==="
          PYTHONPATH=. python -m src.prediction_pipeline --mode cycle --run-prediction 2>&1 | tee pipeline.log

      - name: Step 7 - Check generated files
        if: always()
        run: |
          echo "=== Checking Generated Files ==="
          
          echo "Contents of nvda_learning/:"
          find nvda_learning -type f 2>/dev/null | head -20
          
          echo ""
          echo "Contents of performance_metrics.json:"
          if [ -f "performance_metrics.json" ]; then
            head -20 performance_metrics.json
          else
            echo "File not found"
          fi
          
          echo ""
          echo "Contents of pending_predictions.json:"
          if [ -f "nvda_learning/pending_predictions.json" ]; then
            cat nvda_learning/pending_predictions.json
          else
            echo "File not found"
          fi
          
          echo ""
          echo "Pipeline log (last 50 lines):"
          if [ -f "pipeline.log" ]; then
            tail -50 pipeline.log
          else
            echo "No pipeline.log"
          fi

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-output-${{ github.run_number }}
          path: |
            nvda_learning/
            performance_metrics.json
            pipeline.log
            *.log
          if-no-files-found: warn
          retention-days: 7
