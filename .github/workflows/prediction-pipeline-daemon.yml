name: NVDA Pipeline - Production

on:
  schedule:
    # äºˆæ¸¬ç”Ÿæˆ: æ¯Žå–¶æ¥­æ—¥ UTC 08:55 (æ—¥æœ¬æ™‚é–“ 17:55)
    - cron: '55 8 * * 1-5'
    # å®Ÿç¸¾å–ã‚Šè¾¼ã¿: æ¯Žå–¶æ¥­æ—¥ UTC 16:25 (æ—¥æœ¬æ™‚é–“ 01:25+1)
    - cron: '25 16 * * 1-5'
    # é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼: æ¯Žæ—¥æ›œ UTC 22:00 (æ—¥æœ¬æ™‚é–“ æœˆæ›œ 07:00)
    - cron: '0 22 * * 0'
  workflow_dispatch:

jobs:
  predict:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Determine execution mode
        id: mode
        run: |
          HOUR=$(date -u +%H)
          DAY=$(date -u +%w)
          
          # UTC 08:55 â†’ äºˆæ¸¬å®Ÿè¡Œ
          if [ $HOUR -eq 8 ]; then
            echo "run_prediction=true" >> $GITHUB_OUTPUT
            echo "run_actuals=false" >> $GITHUB_OUTPUT
            echo "run_review=false" >> $GITHUB_OUTPUT
            echo "mode_name=ðŸ“Š Prediction" >> $GITHUB_OUTPUT
          # UTC 16:25 â†’ å®Ÿç¸¾å–ã‚Šè¾¼ã¿
          elif [ $HOUR -eq 16 ]; then
            echo "run_prediction=false" >> $GITHUB_OUTPUT
            echo "run_actuals=true" >> $GITHUB_OUTPUT
            echo "run_review=false" >> $GITHUB_OUTPUT
            echo "mode_name=ðŸ’° Actual Price Collection" >> $GITHUB_OUTPUT
          # UTC 22:00 æ—¥æ›œ â†’ é€±æ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼
          elif [ $HOUR -eq 22 ] && [ $DAY -eq 0 ]; then
            echo "run_prediction=false" >> $GITHUB_OUTPUT
            echo "run_actuals=false" >> $GITHUB_OUTPUT
            echo "run_review=true" >> $GITHUB_OUTPUT
            echo "mode_name=ðŸ“ˆ Weekly Review" >> $GITHUB_OUTPUT
          else
            echo "run_prediction=true" >> $GITHUB_OUTPUT
            echo "run_actuals=true" >> $GITHUB_OUTPUT
            echo "run_review=false" >> $GITHUB_OUTPUT
            echo "mode_name=ðŸ”„ Full Cycle" >> $GITHUB_OUTPUT
          fi

      - name: Run prediction pipeline
        run: |
          echo "ðŸš€ ${{ steps.mode.outputs.mode_name }}"
          echo "=================================================="
          
          PYTHONPATH=. python -m src.prediction_pipeline \
            --mode cycle \
            ${{ steps.mode.outputs.run_prediction == 'true' && '--run-prediction' || '' }} \
            ${{ steps.mode.outputs.run_actuals == 'true' && '--run-actuals' || '' }} \
            ${{ steps.mode.outputs.run_review == 'true' && '--run-review' || '' }}

      - name: Display results
        if: always()
        run: |
          echo ""
          echo "ðŸ“Š Results Summary"
          echo "=================================================="
          
          if [ -f "performance_metrics.json" ]; then
            echo "âœ“ Latest prediction:"
            python << 'PYEOF'
          import json
          with open('performance_metrics.json') as f:
              data = json.load(f)
          if data:
              latest = data[-1]
              print(f"  Ticker: {latest.get('ticker')}")
              print(f"  Predicted: ${latest.get('predicted_price', 0):.2f}")
              if 'actual_price' in latest:
                  print(f"  Actual: ${latest.get('actual_price', 0):.2f}")
                  print(f"  Reward: {latest.get('reward', 0):.4f}")
          PYEOF
          fi
          
          if [ -f "reinforcement_learning.log" ]; then
            echo ""
            echo "âœ“ Latest 3 records:"
            tail -3 reinforcement_learning.log
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nvda-production-${{ github.run_number }}
          path: |
            performance_metrics.json
            reinforcement_learning.log
            nvda_learning/
          if-no-files-found: warn
          retention-days: 30

      - name: Notify completion
        if: always()
        run: |
          echo ""
          echo "âœ… Pipeline execution complete"
          echo "Mode: ${{ steps.mode.outputs.mode_name }}"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
