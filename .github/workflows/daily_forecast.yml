name: Daily Forecast & Archive

on:
  schedule:
    - cron: "0 9 * * *"  # UTC 09:00ÔºàÊó•Êú¨ÊôÇÈñì 18:00Ôºâ
  workflow_dispatch:

jobs:
  daily_forecast:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pandas yfinance scikit-learn holidays

      - name: Generate forecast CSV
        run: |
          echo "üìà Generating forecast..."
          mkdir -p data/predictions_history
          PYTHONPATH=. python scripts/generate_forecast_csv.py \
            --us-symbols AAPL GOOGL MSFT TSLA \
            --jp-symbols 9984 6758 7203 8306 \
            --output data/predictions_history/forecast_$(date +"%Y%m%d_%H%M%S").csv
          echo "‚úÖ Forecast CSV created."

      - name: Combine and validate forecasts
        run: |
          echo "üìä Combining recent forecasts..."
          PYTHONPATH=. python scripts/combine_forecasts.py \
            --input-dir data/predictions_history \
            --output data/forecast_summary.json
          echo "‚úÖ Combined forecast JSON generated."

      - name: Auto-archive today's forecast
        run: |
          echo "üóÇ Archiving latest forecast..."
          PYTHONPATH=. python scripts/auto_archive.py \
            --input data/forecast_summary.json \
            --archive-dir data/archive
          echo "‚úÖ Archive complete."

      - name: Summary
        run: |
          echo "## ‚úÖ Daily Forecast Complete"
          echo ""
          echo "### üìÅ Generated Files"
          echo "- Forecast CSV: data/predictions_history/"
          echo "- Summary JSON: data/forecast_summary.json"
          echo "- Archive: data/archive/"
          echo ""
          echo "### üìä Ready for LLM Analysis"
          echo "Copy data/forecast_summary.json to any LLM"

      - name: Upload forecast artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-forecast-${{ github.run_id }}
          path: |
            data/predictions_history
            data/forecast_summary.json
            data/archive
          if-no-files-found: warn
          retention-days: 14
