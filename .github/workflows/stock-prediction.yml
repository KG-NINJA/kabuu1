
name: Stock Prediction Pipeline

on:
  push:
    branches:
      - main

  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: pytest
      - name: Run flake8
        run: flake8
      - name: Run black
        run: black --check .
      - name: Run mypy
        run: mypy --python-version 3.11 src

  fetch-data:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Fetch market data
        run: |
          python - <<'PY'
          from data_fetcher import fetch_and_save

          def main() -> None:
              try:
                  paths = fetch_and_save()
                  print(f"Fetched {len(paths)} tickers: {list(paths.keys())}")
              except Exception as exc:  # pragma: no cover - CI ログ確認用
                  raise SystemExit(f"Data fetch failed: {exc}")

          if __name__ == "__main__":
              main()
          PY

  preprocess:
    runs-on: ubuntu-latest
    needs: fetch-data
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run feature engineering and preprocessing
        run: |
          python - <<'PY'
          from feature_engineering import build_features
          from preprocessor import run_preprocessing

          build_features()
          run_preprocessing()
          PY

  train-model:
    runs-on: ubuntu-latest
    needs: preprocess
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Train LSTM model
        run: |
          python - <<'PY'
          from train_lstm import LSTMTrainer

          try:
              trainer = LSTMTrainer()
              loss = trainer.train(epochs=1, batch_size=16)
              print(f"LSTM training complete. Loss: {loss:.4f}")
          except ImportError as exc:
              print(f"LSTM training skipped: {exc}")
          PY
      - name: Train XGBoost model
        run: |
          python - <<'PY'
          from train_xgboost import XGBoostTrainer

          try:
              trainer = XGBoostTrainer()
              rmse = trainer.train()
              print(f"XGBoost training complete. RMSE: {rmse:.4f}")
          except ImportError as exc:
              print(f"XGBoost training skipped: {exc}")
          PY

  predict:
    runs-on: ubuntu-latest
    needs: train-model
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Generate forecasts
        run: |
          python - <<'PY'
          from predict import run_prediction

          forecasts = run_prediction()
          print(f"Generated {len(forecasts)} forecast rows")
          PY

  docker-build:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build .

  status:
    runs-on: ubuntu-latest
    needs:
      - predict
      - docker-build
    steps:
      - name: Pipeline summary
        run: echo "Stock prediction pipeline completed successfully."

