# Kabuu1 - ML Prediction Pipeline

高度な機械学習と強化学習を組み合わせた予測パイプラインシステム

## 🎯 概要

- **予測対象**: NVIDIA (NVDA) に特化した単一銘柄フォーカス
- **予測モデル**: LSTM + 強化学習による動的最適化
- **リアルタイム処理**: スケジューラーによる定期実行
- **自動改善**: モデル性能に基づく自動再学習
- **可視化**: ダッシュボード + メトリクス追跡

## 📁 プロジェクト構造

```
kabuu1/
├── src/                          # メインコード
│   ├── reinforcement_learning.py # 強化学習モジュール
│   ├── nvda_reinforcement.py     # NVDA 専用RLオーケストレーター
│   ├── prediction_pipeline.py    # 予測パイプライン
│   └── monitor.py                # モニタリング
├── tests/                        # テストコード
│   ├── test_rl.py               # RL テスト
│   └── test_pipeline.py         # パイプラインテスト
├── config/                       # 設定
│   └── config.yaml              # YAML設定
├── data/                         # 出力は .gitkeep のみを追跡
│   ├── predictions_history/      # 予測CSVの保存先 (自動生成)
│   └── research/                 # 研究用データセット (自動生成)
├── darwin_analysis/              # 解析レポートとLLM用プロンプト (自動生成)
│   └── llm_prompts/
├── logs/                         # ログ出力 (Git無視)
├── .github/
│   └── workflows/
│       ├── Research Tracking.yml     # 精度追跡ワークフロー
│       ├── daily_forecast.yml        # 日次予測とアーカイブ
│       └── prediction-pipeline-ci.yml # 予測パイプラインCI
├── requirements.txt              # 依存関係
├── Dockerfile                    # Docker設定
├── .gitignore                    # Git無視ルール
└── README.md                     # このファイル
```

## 🚀 クイックスタート

### ローカル開発

```bash
# リポジトリのクローン
git clone https://github.com/YOUR_USERNAME/kabuu1.git
cd kabuu1

# 仮想環境作成
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 依存関係インストール
pip install -r requirements.txt

# テスト実行
pytest tests/ -v

# 予測パイプライン実行
python -m src.prediction_pipeline
```

### Docker での実行

```bash
# イメージビルド
docker build -t kabuu1:latest .

# コンテナ実行
docker run -v $(pwd)/data:/app/data kabuu1:latest

# Docker Compose 使用
docker-compose up -d
```

## 🧠 NVDA 専用アーキテクチャ

- `scripts/generate_forecast_csv.py` は NVDA のみを対象にデータを取得
- `src/nvda_reinforcement.py` が強化学習ログを NVDA 専用ディレクトリへ分離
- `src/prediction_pipeline.py` は NVDA のスケジュール実行と自動改善を担保
- LLM プロンプト生成も NVDA の履歴に合わせて最適化

## 📊 機能一覧

### 1. 強化学習ベース最適化
- 予測精度に基づく動的な学習率調整
- ボラティリティを考慮した報酬計算
- 自動モデル改善判定

### 2. 予測パイプライン
- 複数銘柄の並列処理
- スケジューラーによる定期実行
- 実績値との照合と自動更新

### 3. リアルタイム監視
- Flaskベースのダッシュボード
- メトリクスの自動保存
- 性能トレンド分析

### 4. 自動改善
- 精度低下の自動検出
- 緊急改善モード
- パラメータ自動チューニング

## ⚙️ 設定

`config/config.yaml` を編集：

```yaml
model:
  learning_rate: 0.001
  hidden_units: 128
  batch_size: 32
  epochs: 10
  lookback_days: 365

schedule:
  prediction_time: "09:00"
  model_review_day: "sunday"
  model_review_time: "22:00"

logging:
  level: "INFO"
  file: "logs/prediction_pipeline.log"
```

## 📂 生成物とデータ管理

- `data/` と `darwin_analysis/` は自動生成される成果物のみを格納します。
- リポジトリには空の `.gitkeep` だけを含め、成果物は Git にコミットしません。
- GitHub Actions では成果物をリポジトリに push せず、ビルドアーティファクトとして保存します。

## 🧪 テスト

```bash
# すべてのテスト実行
pytest tests/ -v

# カバレッジ付きテスト
pytest tests/ --cov=src --cov-report=html

# 特定のテストファイル
pytest tests/test_rl.py -v
```

## 📈 パフォーマンスメトリクス

システムは以下のメトリクスを自動追跡：

- **予測誤差率**: 実際値との乖離度
- **報酬スコア**: 強化学習の評価値
- **シャープレシオ**: リスク調整済みリターン
- **改善トレンド**: 精度改善傾向

## 🔄 GitHub Actions ワークフロー

以下のワークフローは成果物をアーティファクトとして保存し、リポジトリへ直接 push しません。

- **prediction-pipeline-ci.yml**: main ブランチへの push / PR、平日 06:00/21:00 UTC のスケジュールで予測パイプラインを検証します。
- **daily_forecast.yml**: 毎日 09:00 UTC に実行し、最新予測とアーカイブを生成します。
- **Research Tracking.yml**: 平日 22:00 UTC に精度メトリクスとレポートを更新します。

## 📝 ログ出力

ログは `logs/` ディレクトリに自動保存：

```
logs/
├── prediction_pipeline.log      # 主要ログ
├── reinforcement_learning.log   # RL ログ
└── monitor.log                  # モニタリングログ
```

## 🐛 トラブルシューティング

### 依存関係エラー
```bash
# 依存関係の再インストール
pip install --upgrade -r requirements.txt
```

### TA-Lib のインストール失敗
```bash
# システムライブラリをインストール
sudo apt-get install build-essential
pip install TA-Lib==0.4.28
```

### ポート競合
```bash
# 別のポートでダッシュボード実行
python monitor.py --port 5001
```

## 🤝 貢献

1. Feature ブランチを作成
2. 変更をコミット
3. Pull Request を作成
4. レビュー後に マージ

## 📄 ライセンス

MIT License

## 📞 サポート

問題が発生した場合は GitHub Issues で報告してください。

## 🎓 参考資料

- [TensorFlow ドキュメント](https://www.tensorflow.org/)
- [scikit-learn ドキュメント](https://scikit-learn.org/)
- [強化学習入門](https://www.rl-book.com/)

---

**最終更新**: 2025-11-05
**バージョン**: 1.0.0

# Stock Prediction System - 拡張機能提案

## 現在のシステムの強み
- ✅ **自動パイプライン**: データ取得 → 前処理 → モデル学習 → 予測が自動実行
- ✅ **複数モデル**: LSTM + XGBoost のアンサンブル
- ✅ **多市場対応**: 米国株 + 日本株の同時予測
- ✅ **履歴管理**: 予測結果とモデルの段階的保存
- ✅ **研究追跡**: 実績との比較で精度検証可能

---

## 🎯 優先度の高い拡張機能

### 1. **リアルタイム精度トラッキング**
**現状**: 予測と実績の比較は手動
**提案**: 自動で精度指標を計算・可視化

```
- 毎営業日終了後に実績データを取得
- 前日の予測と比較
- 指標: MAE, RMSE, MAPE, Directional Accuracy
- 銘柄別・信頼度別・市場別に集計
- 時系列グラフで精度トレンド表示
```

**実装**: `Research Tracking Workflow` を拡張
- CSV → JSON での履歴管理
- `accuracy_metrics_YYYY-MM-DD.json` の生成
- `data/research/metrics_history/` に累積保存

---

### 2. **信頼度の動的調整エンジン**
**現状**: 固定の信頼度スコア
**提案**: 過去の予測精度に基づいて信頼度を自動調整

```
例:
- NVDA の信頼度 82% → 実績：78% 精度 → 次回 78% に調整
- 信頼度が低い場合は NVDA 専用データセットを再収集
```

**メリット**:
- より現実的な予測精度
- モデルの過信を防止
- ユーザーが信頼度をより信用可能

---

### 3. **アラート & 異常検知**
**現状**: 予測結果の出力のみ
**提案**: 重要な価格変動をプロアクティブに通知

```
トリガー例:
- 信頼度 85% 以上かつアップサイド 3% 以上
- 信頼度 80% 以上かつダウンサイド 3% 以上
- 複数銘柄の同時トレンド（セクター分析）
- 前日比で予測が大きく変わった
```

**実装**: Slack / Email / Discord への通知

---

### 4. **モデル間の信頼スコア競争**
**現状**: LSTM と XGBoost の結果を別々に保存
**提案**: 実績データで各モデルの精度を比較し、優勝モデルを重み付け

```
学習:
- モデルA (LSTM) 精度 75%
- モデルB (XGBoost) 精度 82%
→ 次の予測で XGBoost の重みを上げる

最終予測 = LSTM × 0.3 + XGBoost × 0.7
```

**メリット**: 時間とともに最適な予測値へ収束

---

### 5. **セクター / グループ分析**
**現状**: 銘柄ごとの予測
**提案**: グループ化して相関分析を追加

```
NVDA の周辺指標:
- GPU 受注動向 / データセンター指数
- 米国半導体 ETF (SOXX) との連動性
- 競合企業の決算スケジュール

分析:
- 指標乖離が NVDA の短期価格に与える影響
- 相関変化を強化学習の報酬に反映
- リスクイベント前後のボラティリティ監視
```

---

### 6. **時系列パターン認識**
**現状**: 1日先予測のみ
**提案**: 複数期間（3日、7日、30日）の予測を同時実行

```
多期間予測:
- 1日先: 短期トレンド
- 3日先: 反発ポイント
- 7日先: 週単位トレンド
- 30日先: 月次トレンド

UI: インタラクティブなタイムラインで表示
```

---

### 7. **カスタムシナリオ分析**
**現状**: 固定の機械学習予測
**提案**: What-If 分析機能を追加

```
シナリオ例:
- 金利が 0.5% 上昇した場合の予測
- ドル円が 150 → 145 に変動した場合
- テクノロジー企業の需要が 10% 減少した場合

実装: 特徴量マニピュレーション → 予測
```

---

### 8. **ダッシュボード + レポート自動生成**
**現状**: JSON/CSV の生データ
**提案**: 美しいレポートを自動生成

```
レポート内容:
- 日次: 今日の予測トップ3銘柄
- 週次: 週単位の精度サマリー
- 月次: モデルパフォーマンス比較
- 年次: 通年の研究成果レポート

フォーマット: PDF, HTML, Markdown
配布: GitHub Pages / Slack
```

---

### 9. **バックテスト & パフォーマンス分析**
**現状**: リアルタイム精度のみ
**提案**: 過去データで遡及テスト

```
バックテスト:
- 過去 1 年のデータで予測を再実行
- 年間 Sharpe Ratio 計算
- 月別/四半期別のドローダウン分析
- 予測ルールの有効性検証
```

---

### 10. **LLM インテグレーション**
**現状**: 数値予測のみ
**提案**: Claude を使った定性分析を追加

```
LLM による分析:
- 予測背景の説明（テクニカル分析から）
- ニュース連携（最近のニュースと予測の関連性）
- リスク要因の言語化
- ユーザーフレンドリーなレポート生成

実装例:
"NVDA は過去 5 日間の上昇トレンド継続予測。
AI サーバー需要と GPU 供給網のニュースが追い風。
ただし米金利上昇と為替変動リスクに要注意。"
```

---

## 📊 実装優先度マトリックス

| 機能 | 開発難度 | 期待度 | 優先度 |
|------|---------|--------|--------|
| リアルタイム精度トラッキング | 低 | 高 | 🔴 最優先 |
| 信頼度の動的調整 | 中 | 高 | 🔴 最優先 |
| アラート & 異常検知 | 中 | 高 | 🟡 高 |
| モデル間競争スコア | 中 | 中 | 🟡 高 |
| セクター分析 | 中 | 中 | 🟡 高 |
| 時系列パターン認識 | 高 | 中 | 🟢 中 |
| カスタムシナリオ | 高 | 中 | 🟢 中 |
| ダッシュボード生成 | 低 | 高 | 🔴 最優先 |
| バックテスト | 高 | 高 | 🟡 高 |
| LLM インテグレーション | 中 | 高 | 🔴 最優先 |

---

## 🚀 実装の最初のステップ

### **フェーズ 1** (今週): 基本の精度トラッキング
```yaml
新しい Workflow: accuracy_tracking.yml
- 毎営業日終了後に実績取得
- accuracy_metrics_YYYY-MM-DD.json 生成
- GitHub リポジトリに自動保存
```

### **フェーズ 2** (来週): ダッシュボード表示
```yaml
React コンポーネント: PredictionAnalytics.jsx
- 過去 30 日の精度トレンド
- 銘柄別の成功率
- 信頼度別の精度分布
```

### **フェーズ 3** (再来週): LLM 分析
```yaml
新スクリプト: llm_analysis.py
- 予測結果 + ニュース → Claude へ送信
- 日本語の定性分析レポート生成
```

---

## 💡 システム全体の流れ（拡張後）

```
1. 自動パイプライン [毎営業日 06:00 UTC]
   ├─ データ取得
   ├─ 前処理
   ├─ モデル学習
   ├─ 予測生成
   └─ 結果保存

2. 精度検証 [毎営業日 22:00 UTC]
   ├─ 実績取得
   ├─ 前日予測と比較
   ├─ 精度指標計算
   ├─ 信頼度調整
   └─ LLM 分析

3. レポート生成 [毎営業日 23:00 UTC]
   ├─ ダッシュボード更新
   ├─ PDF レポート生成
   └─ Slack 通知

4. アーカイブ [毎月末]
   ├─ 月次レポート生成
   ├─ バックテスト実行
   └─ 改善提案の自動生成
```

---

# Stock Prediction System - 拡張機能提案

## 現在のシステムの強み
- ✅ **自動パイプライン**: データ取得 → 前処理 → モデル学習 → 予測が自動実行
- ✅ **複数モデル**: LSTM + XGBoost のアンサンブル
- ✅ **多市場対応**: 米国株 + 日本株の同時予測
- ✅ **履歴管理**: 予測結果とモデルの段階的保存
- ✅ **研究追跡**: 実績との比較で精度検証可能

---

## 🎯 優先度の高い拡張機能

### 1. **リアルタイム精度トラッキング**
**現状**: 予測と実績の比較は手動
**提案**: 自動で精度指標を計算・可視化

```
- 毎営業日終了後に実績データを取得
- 前日の予測と比較
- 指標: MAE, RMSE, MAPE, Directional Accuracy
- 銘柄別・信頼度別・市場別に集計
- 時系列グラフで精度トレンド表示
```

**実装**: `Research Tracking Workflow` を拡張
- CSV → JSON での履歴管理
- `accuracy_metrics_YYYY-MM-DD.json` の生成
- `data/research/metrics_history/` に累積保存

---

### 2. **信頼度の動的調整エンジン**
**現状**: 固定の信頼度スコア
**提案**: 過去の予測精度に基づいて信頼度を自動調整

```
例:
- NVDA の信頼度 82% → 実績：78% 精度 → 次回 78% に調整
- 信頼度が低い場合は NVDA 専用データセットを再収集
```

**メリット**:
- より現実的な予測精度
- モデルの過信を防止
- ユーザーが信頼度をより信用可能

---

### 3. **アラート & 異常検知**
**現状**: 予測結果の出力のみ
**提案**: 重要な価格変動をプロアクティブに通知

```
トリガー例:
- 信頼度 85% 以上かつアップサイド 3% 以上
- 信頼度 80% 以上かつダウンサイド 3% 以上
- SOXX 指数など関連ベンチマークとの乖離
- 前日比で予測が大きく変わった
```

**実装**: Slack / Email / Discord への通知

---

### 4. **モデル間の信頼スコア競争**
**現状**: LSTM と XGBoost の結果を別々に保存
**提案**: 実績データで各モデルの精度を比較し、優勝モデルを重み付け

```
学習:
- モデルA (LSTM) 精度 75%
- モデルB (XGBoost) 精度 82%
→ 次の予測で XGBoost の重みを上げる

最終予測 = LSTM × 0.3 + XGBoost × 0.7
```

**メリット**: 時間とともに最適な予測値へ収束

---

### 5. **セクター / グループ分析**
**現状**: 銘柄ごとの予測
**提案**: グループ化して相関分析を追加

```
NVDA の周辺指標:
- GPU 受注動向 / データセンター指数
- 米国半導体 ETF (SOXX) との連動性
- 競合企業の決算スケジュール

分析:
- 指標乖離が NVDA の短期価格に与える影響
- 相関変化を強化学習の報酬に反映
- リスクイベント前後のボラティリティ監視
```

---

### 6. **時系列パターン認識**
**現状**: 1日先予測のみ
**提案**: 複数期間（3日、7日、30日）の予測を同時実行

```
多期間予測:
- 1日先: 短期トレンド
- 3日先: 反発ポイント
- 7日先: 週単位トレンド
- 30日先: 月次トレンド

UI: インタラクティブなタイムラインで表示
```

---

### 7. **カスタムシナリオ分析**
**現状**: 固定の機械学習予測
**提案**: What-If 分析機能を追加

```
シナリオ例:
- 金利が 0.5% 上昇した場合の予測
- ドル円が 150 → 145 に変動した場合
- テクノロジー企業の需要が 10% 減少した場合

実装: 特徴量マニピュレーション → 予測
```

---

### 8. **ダッシュボード + レポート自動生成**
**現状**: JSON/CSV の生データ
**提案**: 美しいレポートを自動生成

```
レポート内容:
- 日次: 今日の予測トップ3銘柄
- 週次: 週単位の精度サマリー
- 月次: モデルパフォーマンス比較
- 年次: 通年の研究成果レポート

フォーマット: PDF, HTML, Markdown
配布: GitHub Pages / Slack
```

---

### 9. **バックテスト & パフォーマンス分析**
**現状**: リアルタイム精度のみ
**提案**: 過去データで遡及テスト

```
バックテスト:
- 過去 1 年のデータで予測を再実行
- 年間 Sharpe Ratio 計算
- 月別/四半期別のドローダウン分析
- 予測ルールの有効性検証
```

---

### 10. **LLM インテグレーション**
**現状**: 数値予測のみ
**提案**: Claude を使った定性分析を追加

```
LLM による分析:
- 予測背景の説明（テクニカル分析から）
- ニュース連携（最近のニュースと予測の関連性）
- リスク要因の言語化
- ユーザーフレンドリーなレポート生成

実装例:
"NVDA は過去 5 日間の上昇トレンド継続予測。
AI サーバー需要と GPU 供給網のニュースが追い風。
ただし米金利上昇と為替変動リスクに要注意。"
```

---

## 📊 実装優先度マトリックス

| 機能 | 開発難度 | 期待度 | 優先度 |
|------|---------|--------|--------|
| リアルタイム精度トラッキング | 低 | 高 | 🔴 最優先 |
| 信頼度の動的調整 | 中 | 高 | 🔴 最優先 |
| アラート & 異常検知 | 中 | 高 | 🟡 高 |
| モデル間競争スコア | 中 | 中 | 🟡 高 |
| セクター分析 | 中 | 中 | 🟡 高 |
| 時系列パターン認識 | 高 | 中 | 🟢 中 |
| カスタムシナリオ | 高 | 中 | 🟢 中 |
| ダッシュボード生成 | 低 | 高 | 🔴 最優先 |
| バックテスト | 高 | 高 | 🟡 高 |
| LLM インテグレーション | 中 | 高 | 🔴 最優先 |

---

## 🚀 実装の最初のステップ

### **フェーズ 1** (今週): 基本の精度トラッキング
```yaml
新しい Workflow: accuracy_tracking.yml
- 毎営業日終了後に実績取得
- accuracy_metrics_YYYY-MM-DD.json 生成
- GitHub リポジトリに自動保存
```

### **フェーズ 2** (来週): ダッシュボード表示
```yaml
React コンポーネント: PredictionAnalytics.jsx
- 過去 30 日の精度トレンド
- 銘柄別の成功率
- 信頼度別の精度分布
```

### **フェーズ 3** (再来週): LLM 分析
```yaml
新スクリプト: llm_analysis.py
- 予測結果 + ニュース → Claude へ送信
- 日本語の定性分析レポート生成
```

---

## 💡 システム全体の流れ（拡張後）

```
1. 自動パイプライン [毎営業日 06:00 UTC]
   ├─ データ取得
   ├─ 前処理
   ├─ モデル学習
   ├─ 予測生成
   └─ 結果保存

2. 精度検証 [毎営業日 22:00 UTC]
   ├─ 実績取得
   ├─ 前日予測と比較
   ├─ 精度指標計算
   ├─ 信頼度調整
   └─ LLM 分析

3. レポート生成 [毎営業日 23:00 UTC]
   ├─ ダッシュボード更新
   ├─ PDF レポート生成
   └─ Slack 通知

4. アーカイブ [毎月末]
   ├─ 月次レポート生成
   ├─ バックテスト実行
   └─ 改善提案の自動生成
```

---

## 📌 最後に

このシステムは**研究用データセット**として極めて価値があります。

### 活用シーン:
- 📖 **学術論文**: "LSTMとXGBoostの株価予測精度比較研究"
- 💼 **ポートフォリオ最適化**: 多銘柄の関連性分析
- 🤖 **LLM の金融分析能力評価**: Claude vs GPT-4
- 📊 **プロダクト化**: 実際の投資判断ツール

毎日蓄積されるデータは、6ヶ月で強力な研究ベースになります！
Claude Haiku4.5 2025/11/10
